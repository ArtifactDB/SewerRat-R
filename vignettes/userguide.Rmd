---
title: Interacting with the SewerRat REST API
author:
- name: Aaron Lun
  email: infinite.monkeys.with.keyboards@gmail.com
package: SewerRat
date: "Revised: April 2, 2024"
output:
  BiocStyle::html_document
vignette: >
  %\VignetteIndexEntry{Hitting the gypsum API}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE}
library(BiocStyle)
self <- Githubpkg("ArtifactDB/SewerRat")
knitr::opts_chunk$set(error=FALSE, warning=FALSE, message=FALSE)
```

# Introduction

The `r self` package implements an R client for the [API of the same name](https://github.com/ArtifactDB/SewerRat).
This allows users to easily query the SewerRat search index, register or deregister their own directories in the index, and quickly save and load Bioconductor objects for registration.
It is assumed that the users of the `r self` client and the SewerRat API itself are accessing the same shared filesystem;
this is typically the case for high-performance computing (HPC) clusters in scientific institutions.
For demonstration purposes, we'll set up a test instance of the API on our local machine:

```{r}
library(SewerRat)
info <- startSewerRat()
info$url
```

# Registering directories

Let's mock up a directory of metadata files:

```{r}
mydir <- tempfile()
dir.create(mydir)
write(file=file.path(mydir, "metadata.json"), '{ "name": "foo", "description": "bar" }')
dir.create(file.path(mydir, "stuff"))
write(file=file.path(mydir, "stuff", "metadata.json"), '{ "food": "barramundi" }')
```

We can then easily register it with the `register()` function.
The example below will only index metadata files inside `mydir` named 'metadata.json', though any number of base names can be supplied here.

```{r}
library(SewerRat)
register(mydir, names="metadata.json", url=info$url) 
```

Similarly, we can deregister this directory with `deregister()`.
All registration actions assume that the caller has write access to the to-be-(de)registered directory.

# Searching the index

We use the `query()` function to perform free-text searches on the indexed metadata.

```{r}
lapply(query("foo", url=info$url), function(x) x$path)
lapply(query("bar%", url=info$url), function(x) x$path) # partial match to 'bar...'
lapply(query("bar% AND foo", url=info$url), function(x) x$path) # boolean operations
lapply(query("food:bar%", url=info$url), function(x) x$path) # match in the 'food' field
```

We can also search on the user, path components, and time of creation:

```{r}
lapply(query(user=Sys.info()["user"], url=info$url), function(x) x$path) # created by myself
lapply(query(path="stuff", url=info$url), function(x) x$path) # path has 'stuff' in it
lapply(query(from=Sys.time() - 3600, url=info$url), function(x) x$path) # created less than 1 hour ago
```

Or indeed, any combination of these fields, which are treated as a boolean AND in the query:

```{r}
query("barramundi", path="stuff", url=info$url)
```

# Administrator instructions

The URL to the SewerRat REST API depends on the instance and needs to be specified correctly before `r self` functions can be used.
Administrators of an R installation can achieve this by setting the `SEWERRAT_REST_URL` environment variable before `r self` package load.
Developers of packages that call `r self` can either pass in a URL to the `url=` argument in various `r self` functions,
or they can globally set the URL via the `restUrl()` function.

# Session information {-}

```{r}
sessionInfo()
```
